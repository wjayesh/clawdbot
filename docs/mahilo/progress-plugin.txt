# Mahilo Plugin Development Progress

Started: 2026-01-27
Last Updated: 2026-01-28

---

## Current Focus

Phase 1 Core Implementation - **100% Complete (38/38 tasks)**

## Key Files

- `docs/mahilo/plugin-design.md` - Full design specification
- `docs/mahilo/tasks-plugin.md` - Phase 1 tasks with priorities and acceptance criteria
- `docs/mahilo/plugin-docs-findings.md` - Design review findings to address

## Task Summary

| Priority | Total | Pending | In Progress | Done |
|----------|-------|---------|-------------|------|
| P0       | 29    | 0       | 0           | 29   |
| P1       | 7     | 0       | 0           | 7    |
| P2       | 2     | 0       | 0           | 2    |
| **Total**| 38    | 0       | 0           | 38   |

## Remaining Tasks

None - Phase 1 complete!

**PLG-034** (P0): E2E Test - Full Message Exchange ✅
- Test passes: registry delivers message to plugin webhook
- Gateway logs show receipt and message content

## Dependencies

The plugin depends on the Mahilo Registry being available for:
- PLG-034 (E2E Test) - needs full registry

For development, the plugin mocks registry responses in tests.

## Findings Addressed

- ✅ HIGH-1: Raw body signature verification (src/webhook/signature.ts)
- ✅ HIGH-2: Message deduplication (src/webhook/dedup.ts)
- ✅ MED-5: Inbound policy filtering (src/policy/local-filter.ts)
- ✅ MED-7: Correct acknowledgement format (`{ acknowledged: true }`)
- ⏳ CRIT-1: E2E encryption (deferred to Phase 2)

## Test Coverage

All tests in `extensions/mahilo/tests/`:
- `client.test.ts` - Mahilo API client (sendMessage, getFriends, registerAgent, errors)
- `signature.test.ts` - HMAC signature verification
- `policy.test.ts` - Local policy enforcement
- `dedup.test.ts` - Message deduplication
- `tools.test.ts` - talk_to_agent and list_mahilo_contacts tools
- `webhook.test.ts` - Full webhook handler integration tests

## Session Log

### Session 1 (2026-01-27)

**Completed:**
- Created full plugin directory structure under `extensions/mahilo/`
- Implemented plugin manifest (`moltbot.plugin.json`) with config schema
- Created Mahilo API client with:
  - HTTP client with retry logic and timeouts
  - sendMessage(), getFriends(), getContactConnections(), registerAgent()
  - Error handling with typed error codes
- Implemented `talk_to_agent` tool with:
  - Recipient connection selection based on labels/capabilities
  - Local policy enforcement
  - Helpful error messages
- Implemented `list_mahilo_contacts` tool
- Implemented webhook handler with:
  - HMAC-SHA256 signature verification using raw body bytes
  - Message deduplication by message_id
  - Async agent run triggering
  - Inbound policy filtering
- Implemented local policy filter for outbound and inbound messages
- Created unit tests for signature verification, policies, and deduplication
- Created comprehensive README documentation
- Registered tools and routes via Clawdbot plugin API
- Set up lifecycle hooks for auto-registration and cleanup

### Session 2 (2026-01-27)

**Completed:**
- Created comprehensive unit tests for Mahilo client (`tests/client.test.ts`)
- Created unit tests for tools (`tests/tools.test.ts`)
- Created integration tests for webhook handler (`tests/webhook.test.ts`)
- Created agent instructions template (`docs/AGENT-INSTRUCTIONS.md`)
- Updated tasks-plugin.md: 35/37 tasks done

### Session 3 (2026-01-27)

**Completed:**
- Reviewed and verified all plugin implementation
- Updated progress tracking to reflect accurate 95% completion
- Fixed test mocks (async iterable request, duplicate mock calls)
- **All 119 tests pass** across 6 test files:
  - `client.test.ts` - 39 tests
  - `signature.test.ts` - 7 tests
  - `policy.test.ts` - 22 tests
  - `dedup.test.ts` - 7 tests
  - `tools.test.ts` - 25 tests
  - `webhook.test.ts` - 19 tests

**Notes:**
- The plugin follows patterns from existing extensions (discord, llm-task)
- Tools are registered as optional to allow loading without API key
- Webhook handler acknowledges immediately, processes async
- Policy filter runs synchronously before network calls
- Agent triggering currently logs (Phase 1); full cron integration awaits SDK enhancement

### Session 4 (2026-01-28)

**Completed:**
- Added talk_to_group tool implementation + tests
- Registered talk_to_group with the plugin
- Updated docs/task tracking to reflect group support and correct config paths

### Session 5 (2026-01-28)

**Completed:**
- Added Mahilo registry keypair generation for registerAgent
- Added talk_to_group not-supported handling + docs note
- Added E2E test harness for registry message routing (awaiting registry runtime)

### Session 6 (2026-01-28)

**Completed:**
- Wrote registry + E2E handover doc with exact commands and expected signals

**Blocked:**
- Bun install failed (brew returned exit 1; bun.sh install failed DNS)
- OrbStack app missing executable; Docker engine not available

### Session 7 (2026-01-28)

**Completed:**
- Installed Bun via Homebrew (`brew install oven-sh/bun/bun`)
- Started Mahilo registry (`bun run dev` in ../mahilo-2)
- Diagnosed root cause: `gateway_start` hook defined but never called in gateway server
- Refactored plugin to use `registerService` instead of `api.on("gateway_start", ...)`
  - Services run after HTTP server is listening (correct timing for webhook registration)
  - Reads port from `ctx.config.gateway.port` or uses `callback_url_override`
- **E2E test passes**: Full message flow verified (Alice → Registry → Bob's webhook)
- All 132 unit tests still pass

**Key insight:**
The `gateway_start` typed hook is implemented in `src/plugins/hooks.ts` but `runGatewayStart()`
is never called anywhere. Plugin services are the correct mechanism for post-startup initialization
since their `start()` method runs after HTTP is listening.

### Session 8 (2026-01-28)

**Goal:** Phase 2 Agent Runner Integration (PLG-060, PLG-061, PLG-062)

**Completed:**
- PLG-060: Implemented agent runner integration using `callGateway({ method: "agent", ... })`
  - Updated `trigger-agent.ts` to call gateway's agent method when webhook receives message
  - Uses `idempotency_key` based on message_id for deduplication
  - Includes `extraSystemPrompt` with sender context
- PLG-061: Added inbound routing config for target session
  - Added `inbound_session_key` (default: "main") and `inbound_agent_id` to MahiloPluginConfig
  - Updated config.ts with defaults and resolveConfig
- PLG-062: Added tests for agent runner integration
  - 13 new unit tests for formatting and config integration
  - All 145 Mahilo unit tests pass
  - E2E test requires working registry (mahilo-2 repo has compilation error)

**Approach:**
- Used `callGateway` from `src/gateway/call.ts` (same pattern as `sessions_send` tool)
- No core modifications needed - imported internal function directly
- Replaced logging stub in `trigger-agent.ts` with actual agent invocation

**Files changed:**
- `extensions/mahilo/src/types.ts` - Added inbound_session_key and inbound_agent_id
- `extensions/mahilo/src/config.ts` - Added defaults for inbound routing
- `extensions/mahilo/src/webhook/trigger-agent.ts` - Implemented callGateway integration
- `extensions/mahilo/src/webhook/handler.ts` - Pass config to triggerAgentRun
- `extensions/mahilo/tests/trigger-agent.test.ts` - New tests for formatting and config
- `test/mahilo.e2e.test.ts` - Also check stderr for log lines

**E2E Test Result:**
- Full flow verified: Alice → Registry → Bob's webhook → Agent run triggered
- 145 unit tests pass + 1 E2E test passes
